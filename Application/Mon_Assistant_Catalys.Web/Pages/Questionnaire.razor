@inject IJSRuntime JSRuntime;
@using Mon_Assistant_Catalys.Web.Models
@using Mon_Assistant_Catalys.Web.Services
@using Microsoft.AspNetCore.Components.Web
@using System.Net;

<style type="text/css">

    .chat-area {
        height: auto;
        background-color: #f8f9fa;
        padding: 10px 10px 10px 10px;
        overflow-x: hidden;
        overflow-x: auto;
    }

    .chat-list {
        padding: 0;
        width: 100%;
        list-style-type: none;
    }

    .chat-input {
        min-height: 80px;
        background-color: #e9ecef;
        padding: 5px 5px 5px 5px;
    }

    .message {
        width: 100%;
        display: inline-block;
        margin-bottom: 10px;
    }

    .user-datestamp {
        font-size: 12px;
        width: 100%;
        text-align: right;
    }

    .bot-datestamp {
        font-size: 12px;
        width: 100%;
        text-align: left;
    }


    .user-message-container {
        float: right;
        background-color: #17a2b8;
        border-radius: 12px;
        border-bottom-right-radius: 2px;
        position: relative;
        display: inline-block;
        word-wrap: break-word;
        font-size: 16px;
        color: white;
        padding: 15px 15px 15px 15px;
        max-width: 90%
    }

    .bot-message-container {
        float: left;
        border-radius: 12px;
        border-bottom-left-radius: 2px;
        position: relative;
        display: inline-block;
        word-wrap: break-word;
        font-size: 16px;
        color: white;
        max-width: 90%
    }

    .btn-bot {
        color: hotpink;
        background-color: pink;
        border-radius: 5px;
        padding: 5px 15px;
        margin: 3px;
    }

    .message-answers {
        background-color: #C7d0d8;
        padding: 15px 15px 15px 15px;
        border-bottom-right-radius: 12px;
    }

    .bot-message-text {
        background-color: #EE7813;
        border-radius: 12px;
        border-bottom-left-radius: 2px;
        border-bottom-right-radius: 2px;
        padding: 5px
    }

    .btn-no-limit {
        max-width : inherit;
        width : inherit;
        margin-top : 5px;
        background-color : white;
        color : black;
    }

</style>

<div class="chat-window">
    <div class="chat-area" id="ChatBody">
        <ul class="chat-list">
            @foreach (Message msg in Messages)
            {
                <li class="message">
                    @if (msg.Type == Message.MessageType.UserMessage)
                    {
                        <div class="user-datestamp">@msg.DateStamp</div>
                        <div class="user-message-container">
                            <div class="message-text">@msg.MessageContent</div>
                        </div>
                    }
                    else
                    {

                        <div class="bot-datestamp">@msg.DateStamp</div>
                        <div class="bot-message-container">
                            <div class="bot-message-text">@msg.MessageContent</div>

                            @if (msg.LinkedQuestion.IsQuestionAfterAnwser())
                            {
                                <div class="message-answers">
                                    <div class="row">
                                        @foreach (Answer answer in msg.LinkedQuestion.Answers)
                                        {
                                            <div class="col-md-12">
                                                <button id="@answer.Id" class="btn btn-outline-light btn-no-limit" @onclick="(e => ProcessMessage(answer.Id))">@answer.Text</button>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                            else
                            {
                                AddMessageContent(@msg.MessageContent);
                                <button class="btn btn-outline-light btn-no-limit" @onclick="(e => GenerateFile())">Télécharger le fichier</button>
                            }

                        </div>

                    }
                </li>
            }
        </ul>
    </div>
</div>

@code
{ [Parameter]
    public string fileName { get; set; }
    public Guid SessionID { get; set; } = Guid.NewGuid();
    private string UserMessage { get; set; }
    private List<Models.Message> Messages { get; set; } = new List<Models.Message>();

    public Question question { get; set; }
    public Answer answer { get; set; }

    Question currentQuestion = null;

    public Mon_Assistant_Catalys.Web.Models.Questionnaire questionnaire = new Mon_Assistant_Catalys.Web.Models.Questionnaire();
    QuestionnaireService service = new QuestionnaireService();

    List<Question> toDisplayTree = null;
    public string messageContent = "";

    protected override void OnInitialized()
    {
        question = new Question();

        questionnaire = service.GetQuestionnaire();

        toDisplayTree = new List<Question>();

        toDisplayTree = service.TransformToTree();

        foreach (Question q in questionnaire.Questions)
        {
            if (q.IdQuestion == 1)
            {
                currentQuestion = q;
            }
        }
        Messages.Add(new Message() { MessageContent = currentQuestion.Text, Type = Message.MessageType.BotMessage, LinkedQuestion = currentQuestion });
    }

    private void ProcessMessage(int idQuestion)
    {
        try
        {
            Answer currentRep = currentQuestion.Answers.Find(r => r.Id == idQuestion);
            Messages.Add(new Message() { MessageContent = currentRep.Text, Type = Message.MessageType.UserMessage });

            currentQuestion = currentRep.Question;
            Messages.Add(new Message() { MessageContent = currentQuestion.Text, Type = Message.MessageType.BotMessage, LinkedQuestion = currentQuestion });
        }
        catch (Exception)
        {
        }
    }

    private async void ScrollChat()
    {
        await JSRuntime.InvokeAsync<string>("scrollChat");
    }

    /// <summary>
    ///     Génère le fichier de sortie en fin d'échange avec l'assistant.
    /// </summary>
    public void GenerateFile()
    {
        string actualDate = DateTime.Now.Day.ToString() + "-" + DateTime.Now.Month.ToString() + "-" + DateTime.Now.Year.ToString()
                    + "-" + DateTime.Now.Hour.ToString() + "-" + DateTime.Now.Minute.ToString() + "-" + DateTime.Now.Second.ToString();

        string filePath = "Files\\Fichier-sortie-" + actualDate + ".txt";

        service.CreateFile(messageContent);

        // Téléchargement du fichier
        using (WebClient client = new WebClient())
        {
            client.DownloadFile(filePath, @"C:\\temp\\test.txt");
        }

    }

    public void AddMessageContent(string messageToAdd)
    {
        messageContent = messageToAdd;
    }

}

